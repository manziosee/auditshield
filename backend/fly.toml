# AuditShield Backend — Fly.io deployment config
# Deploy: fly deploy --config fly.toml (from backend/ directory)
# Docs:   https://fly.io/docs/reference/configuration/

app = "auditshield-backend"
primary_region = "jnb"   # Johannesburg — closest to East Africa

[build]
  dockerfile = "Dockerfile.prod"

[env]
  DJANGO_SETTINGS_MODULE = "auditshield.settings.production"
  PYTHONUNBUFFERED       = "1"
  PORT                   = "8080"
  GUNICORN_WORKERS       = "2"
  # SQLite lives on the persistent volume at /data
  TURSO_DATABASE_URL     = "file:/data/db.sqlite3"
  MEDIA_ROOT             = "/data/media"
  STATIC_ROOT            = "/data/staticfiles"
  # All secrets must be set via: fly secrets set KEY=value
  # Required: DJANGO_SECRET_KEY, FILE_ENCRYPTION_KEY,
  #           DJANGO_ALLOWED_HOSTS, CORS_ALLOWED_ORIGINS
  # Optional: REDIS_URL, CELERY_BROKER_URL (if using Upstash Redis),
  #           EMAIL_HOST_USER, EMAIL_HOST_PASSWORD, SENTRY_DSN

[http_service]
  internal_port        = 8080
  force_https          = true
  auto_stop_machines   = true
  auto_start_machines  = true
  min_machines_running = 1        # keep 1 always-on for zero cold starts

  [http_service.concurrency]
    type       = "requests"
    hard_limit = 100
    soft_limit = 80

  [[http_service.checks]]
    grace_period = "15s"
    interval     = "30s"
    method       = "GET"
    path         = "/health/"
    protocol     = "http"
    timeout      = "5s"

[[mounts]]
  source      = "auditshield_data"
  destination = "/data"

[[vm]]
  memory   = "512mb"
  cpu_kind = "shared"
  cpus     = 1
